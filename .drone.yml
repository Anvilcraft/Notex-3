kind: pipeline
name: release
steps:
    - name: build
      image: haxe:4.2.0-alpine
      commands:
          - apk add openjdk8-jre curl
          # Download MPT
          - curl 'https://data.tilera.xyz/file/mpt/mpt-1.2-SNAPSHOT.jar' -o mpt.jar

          - haxelib setup /usr/share/haxe/lib
          - haxelib install kubejs

          - ./buildhaxe.sh
          - java -jar mpt.jar buildtwitch
          - java -jar mpt.jar createmodlist --all HTML build/modlist.html

          - mv build/notex-*-twitch.zip build/notex-twitch.zip

    - name: publish
      image: plugins/gitea-release
      settings:
          base_url: https://data.tilera.xyz/git
          api_key:
              from_secret: gitea_token
          note: CHANGELOG.md
          title: tag-${DRONE_TAG}
          files:
              - build/notex-twitch.zip
              - build/modlist.html
      when:
          event: tag
      depends_on:
          - build

